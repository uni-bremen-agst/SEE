services:
  traefik:
    image: traefik:v2.9
    command:
      - --providers.docker
      - --entrypoints.web.address=:80
      - --api.insecure=true
    ports:
      - "80:80"
      # Uncomment this line to enable the traefik dashboard
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  frontend:
    build: ./Frontend
    container_name: see-frontend
    restart: always
    image: ghcr.io/uni-bremen-agst/see-manager-frontend:1.0.0
    depends_on:
      - backend
      - traefik
    environment:
      # Backend API URL
      VITE_APP_API_URL: http://see.localhost/api/v1/
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${DOMAIN_NAME}`) && !PathPrefix(`/api`)"
      - "traefik.http.services.frontend.loadbalancer.server.port=8080"
    networks:
      - traefik
      - default

  backend:
    privileged: true
    build: ./Backend
    container_name: see-backend
    image: ghcr.io/uni-bremen-agst/see-manager-backend:1.0.0
    restart: always
    depends_on:
      - traefik
    volumes:
      - backend-data:/see
      # - /var/run/docker.sock:/var/run/docker.sock
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - ":8080"
    environment:
      # You should not change these values here.
      # Use the env file instead
      BACKEND_DOMAIN: ${DOMAIN_NAME}
      FRONTEND_DOMAIN: ${DOMAIN_NAME}
      FRONTEND_SCHEME: HTTP
      FILESTORAGE_DIR: /see/file-storage
      SQLITE_DB_FILE: /see/database.db
      # Docker daemon must be reachable from backend container to spawn game servers.
      DOCKER_HOST: unix:///var/run/docker.sock
      # This is the docker host's external IP or domain. Game servers will be reachable on this host.
      DOCKER_HOST_EXTERNAL: ${DOCKER_HOST_EXTERNAL}
      GAME_SERVER_IMAGE: ${DOCKER_IMAGE_NAME}
      # JWT settings
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION}
      # This will add an admin account to the backend. Use with care!
      ADD_ADMIN_NAME: admin
      ADD_ADMIN_PASSWORD: admin
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`${DOMAIN_NAME}`) && PathPrefix(`/api`)"
      - "traefik.http.services.backend.loadbalancer.server.port=8080"
    networks:
      - traefik
      - default

networks:
  traefik:
  default:


volumes:
  backend-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./backend-data
